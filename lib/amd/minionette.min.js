// Backbone.Minionette
// -------------------
// v0.3.0
//
// Copyright (c)2013 Justin Ridgewell
// Distributed under MIT license
//
// https://github.com/jridgewell/minionette

(function(e,i){"use strict";if("object"==typeof exports){var t=require("underscore"),n=require("jquery"),r=require("backbone");module.exports=i(t,n,r)}else"function"==typeof define&&define.amd&&define(["underscore","jquery","backbone"],i)})(this,function(e,i,t){"use strict";return function(e,t,n,r){var s={};return r.Minionette=s,function(e){if(e){var i=e.cleanData,n=e("<span />"),r=!0;n.on("remove",function(){r=!1}),n.remove(),r&&(e.cleanData=function(n){t.each(n,function(i){try{e(i).triggerHandler("remove")}catch(t){}}),i(n)})}}(i),s.Region=function(e){this.cid=t.uniqueId("subview"),e&&e.view&&(this.view=e.view),this._ensureView()},s.Region.extend=r.View.extend,t.extend(s.Region.prototype,r.Events,{_View:r.View.extend({tagName:"span",attributes:function(){return{"data-cid":this.cid}}}),_ensureView:function(){this._view=new this._View,this.view instanceof r.View||(this.view=this._view),this._assignParent(this.view)},reset:function(){this.attach(this._view)},render:function(){return this.view.render()},attach:function(e){return this._assignParent(e),this.view.$el.after(e.$el),this.view.$el.detach(),this.view=e,e},remove:function(){var e=this.view;return this.reset(),e.remove(),e},detach:function(){return this._detachedView=this.view,this.reset(),this},reattach:function(){if(this._detachedView){var e=this._parent&&this._parent.$el||r.$(document.body),i="[data-cid="+this.view.cid+"]",t=this._detachedView;return e.find(i).replaceWith(t.$el),delete this._detachedView,this.view=t,t}},_removeView:function(e){this.view===e&&this.reset()},_assignParent:function(e){e._parent=this}}),s.View=r.View.extend({constructor:function(e){this._initializeRegions(e||{}),t.bindAll(this,"_jqueryRemove","_viewHelper"),r.View.apply(this,arguments),this._listenToEvents(this.model,t.result(this,"modelEvents")),this._listenToEvents(this.collection,t.result(this,"collectionEvents"))},Region:s.Region,template:function(){return""},serializeData:function(){return{}},_serializeData:function(){return t.extend({view:this._viewHelper},this.serializeData())},delegateEvents:function(){s.View.__super__.delegateEvents.apply(this,arguments),this.$el.on("remove.delegateEvents"+this.cid,this._jqueryRemove)},remove:function(){this._isRemoving||(this._isRemoving=!0,this.trigger("remove:before"),this._removeFromParent(),t.invoke(this._regions,"remove"),s.View.__super__.remove.apply(this,arguments),this.trigger("remove"))},render:function(){return this.trigger("render:before"),t.invoke(this._regions,"detach"),this.$el.html(this.template(this._serializeData())),t.invoke(this._regions,"reattach"),this.trigger("render"),this},addRegion:function(e,i){var t=new this.Region({view:i});return t._parent=this,this[e]=this._regions[e]=t,t},_removeFromParent:function(){this._parent&&this._parent._removeView&&(this._parent._removeView(this),this._parent=null)},_jqueryRemove:function(){this.trigger("remove:jquery"),this.remove()},_listenToEvents:function(e,i){e&&t.each(i,function(i,n){t.isFunction(i)||(i=this[i]),this.listenTo(e,n,i)},this)},_initializeRegions:function(e){this._regions={};var i=t.result(this,"regions");e.regions&&(i=e.regions),t.each(i,function(e,i){this.addRegion(i,e)},this)},_viewHelper:function(e){var i=this._regions[e];return i?i.render().el.outerHTML:""}}),s.ModelView=s.View.extend({modelEvents:{change:"render",destroy:"remove"},serializeData:function(){return this.model.attributes}}),s.CollectionView=s.View.extend({ModelView:r.View,collectionEvents:{add:"addOne",remove:"removeOne",reset:"render",sort:"render"},render:function(){this.trigger("render:before"),this._modelViews={};var e=this._getModelView(),i=this.$el.html(this.template(this._serializeData()));return this.$el=n(document.createDocumentFragment()),this.collection.each(function(i){this._addModelView(i,e)},this),this.$el=i.append(this.$el),this.trigger("render"),this},addOne:function(e){this.trigger("addOne:before");var i=this._getModelView(),t=this._addModelView(e,i);return this.trigger("addOne"),t},removeOne:function(e){this.trigger("removeOne:before");var i=this._findModelViewByModel(e);return i&&i.remove(),this.trigger("removeOne"),i},_addModelView:function(e,i){var t=new i({model:e});return this._modelViews||(this._modelViews={}),this._modelViews[t.cid]=t,t._parent=this,this.$el.append(t.render().$el),t},_getModelView:function(){var e=this.ModelView;return this.options&&this.options.ModelView&&(e=this.options.ModelView),e},_findModelViewByModel:function(e){return t.findWhere(this._modelViews,{model:e})}}),s}(this,e,i,t),t.Minionette});