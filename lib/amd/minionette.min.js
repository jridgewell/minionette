// Backbone.Minionette
// -------------------
// v0.5.1
//
// Copyright (c)2013 Justin Ridgewell
// Distributed under MIT license
//
// https://github.com/jridgewell/minionette

(function(e,i){"use strict";if("object"==typeof exports){var t=require("underscore"),n=require("jquery"),s=require("backbone");module.exports=i(t,n,s)}else"function"==typeof define&&define.amd&&define(["underscore","jquery","backbone"],i)})(this,function(e,i,t){"use strict";return function(e,t,n,s){var r={};return s.Minionette=r,function(e){if(e){var i=e.cleanData,n=e("<span />"),s=!0;n.on("remove",function(){s=!1}),n.remove(),s&&(e.cleanData=function(n){t.each(n,function(i){try{e(i).triggerHandler("remove")}catch(t){}}),i(n)})}}(i),r.View=s.View.extend({constructor:function(e){e||(e={}),this._ensureRegion(e),this._initializeRegions(e),t.bindAll(this,"_jqueryRemove","_viewHelper"),s.View.apply(this,arguments),this._listenToEvents(this.model,t.result(this,"modelEvents")),this._listenToEvents(this.collection,t.result(this,"collectionEvents"))},template:function(){return""},serialize:function(){return{}},_serialize:function(){return t.extend({view:this._viewHelper},this.serialize())},delegateEvents:function(){r.View.__super__.delegateEvents.apply(this,arguments),this.$el.on("remove.delegateEvents"+this.cid,this._jqueryRemove)},remove:function(){this._isRemoving||(this._isRemoving=!0,this.trigger("remove"),this._removeFromParent(),t.invoke(this._regions,"remove"),r.View.__super__.remove.apply(this,arguments),delete this._jqueryRemove,delete this._viewHelper,this.unbind())},render:function(){return this.trigger("render"),t.invoke(this._regions,"detach"),this.$el.html(this.template(this._serialize())),t.invoke(this._regions,"reattach"),this},addRegion:function(e,i){var t=new this.Region({view:i});return this._regions[e]&&this._regions[e].remove(),t.name=e,t._parent=this,this[e]=this._regions[e]=t,t},addRegions:function(e){t.each(e,function(e,i){this.addRegion(i,e)},this)},_removeFromParent:function(){this._parent&&this._parent._removeView&&this._parent._removeView(this),this._parent=null},_removeRegion:function(e){this._regions[e.name]&&(delete this[e.name],delete this._regions[e.name])},_jqueryRemove:function(){this.trigger("remove:jquery"),this.remove()},_listenToEvents:function(e,i){e&&t.each(i,function(i,n){t.isFunction(i)||(i=this[i]),this.listenTo(e,n,i)},this)},_ensureRegion:function(e){this.Region=e.Region||this.Region||r.Region},_initializeRegions:function(e){this._regions={};var i=t.result(this,"regions");e.regions&&(i=e.regions),this.addRegions(i)},_viewHelper:function(e){var i=this._regions[e];return i?i.render().el.outerHTML:""}}),r.Region=function(e){this.cid=t.uniqueId("region"),this._ensureView(e||{})},r.Region.extend=s.View.extend,t.extend(r.Region.prototype,s.Events,{View:r.View.extend({tagName:"span",attributes:function(){return{"data-cid":this.cid}}}),_ensureView:function(e){this._view=new this.View,e.view&&(this.view=e.view),this.view instanceof s.View||(this.view=this._view),this._assignParent(this.view)},reset:function(e){this.attach(this._view,e)},render:function(){return this.view.render()},attach:function(e,i){this._assignParent(e);var t=this.view;return this.view.$el.after(e.$el),this.view.$el.detach(),this.view=e,i||t.remove(),e},remove:function(){this._removeViews(),this._removeFromParent()},_removeViews:function(){this.view.remove(),this._view.remove(),this._detachedView&&this._detachedView.remove()},_removeFromParent:function(){this._parent&&this._parent._removeRegion&&this._parent._removeRegion(this),this._parent=null},detach:function(){return this._detachedView&&this._detachedView.remove(),this._detachedView=this.view,this.view!==this._view&&this.reset(!0),this},reattach:function(){if(this._detachedView){var e=this._parent&&this._parent.$el||s.$(document.body),i="[data-cid="+this.view.cid+"]",t=this._detachedView;return e.find(i).replaceWith(t.$el),delete this._detachedView,this.view=t,t}},_removeView:function(e){this.view===e&&this.reset(!0)},_assignParent:function(e){e._parent=this}}),r.ModelView=r.View.extend({modelEvents:{change:"render",destroy:"remove"},serialize:function(){return this.model.attributes}}),r.CollectionView=r.View.extend({constructor:function(e){this._modelViews={},this._ensureModelView(e||{}),r.View.apply(this,arguments),this.listenTo(this,"remove",this._removeModelViews)},collectionEvents:{add:"addOne",remove:"removeOne",reset:"render",sort:"render"},render:function(){this.trigger("render"),this._removeModelViews();var e=this.$el.html(this.template(this._serialize()));return this.$el=n(document.createDocumentFragment()),this.collection.each(this._addModelView,this),this.$el=e.append(this.$el),this},addOne:function(e){this.trigger("addOne");var i=this._addModelView(e);return i},removeOne:function(e){this.trigger("removeOne");var i=t.findWhere(this._modelViews,{model:e});return i&&i.remove(),i},_addModelView:function(e){var i=new this.ModelView({model:e});return this._modelViews[i.cid]=i,i._parent=this,this.$el.append(i.render().$el),i},_removeView:function(e){delete this._modelViews[e.cid]},_removeModelViews:function(){t.invoke(this._modelViews,"remove")},_ensureModelView:function(e){this.ModelView=e.ModelView||this.ModelView||r.ModelView}}),r}(this,e,i,t),t.Minionette});