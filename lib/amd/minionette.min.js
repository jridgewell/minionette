// Backbone.Minionette
// -------------------
// v0.6.0
//
// Copyright (c)2013 Justin Ridgewell
// Distributed under MIT license
//
// https://github.com/jridgewell/minionette

!function(a,b){"use strict";if("object"==typeof exports){var c=require("underscore"),d=require("jquery"),e=require("backbone");module.exports=b(c,d,e)}else"function"==typeof define&&define.amd&&define(["underscore","jquery","backbone"],b)}(this,function(a,b,c){"use strict";return function(a,b,c,d){function e(a,c){if(null==a)return void 0;var d=b.rest(arguments,2);return b.isFunction(a[c])?a[c].apply(a,d):void 0}var f={};d.Minionette=f;var g=c.cleanData,h=c("<span />");return h.on("remove",function(){g=null}),h.remove(),g&&(c.cleanData=function(a){b.each(a,function(a){try{c(a).triggerHandler("remove")}catch(b){}}),g(a)}),f.View=d.View.extend({constructor:function(a){a||(a={}),this._ensureRegion(a),this._initializeRegions(a),b.bindAll(this,"_jqueryRemove","_viewHelper"),d.View.apply(this,arguments),this._listenToEvents(this.model,b.result(this,"modelEvents")),this._listenToEvents(this.collection,b.result(this,"collectionEvents"))},template:function(){return""},serialize:function(){return{}},_serialize:function(){return b.extend({view:this._viewHelper},this.serialize())},delegateEvents:function(){f.View.__super__.delegateEvents.apply(this,arguments),this.$el.on("remove.delegateEvents"+this.cid,this._jqueryRemove)},remove:function(){this._isRemoving||(this._isRemoving=!0,this.trigger("remove"),this._removeFromParent(),b.invoke(this._regions,"remove"),f.View.__super__.remove.apply(this,arguments),delete this._jqueryRemove,delete this._viewHelper,this.unbind())},render:function(){return this.trigger("render"),b.invoke(this._regions,"detach"),this.$el.html(this.template(this._serialize())),b.invoke(this._regions,"reattach"),this},addRegion:function(a,b){var c=new this.Region({view:b});return e(this._regions[a],"remove"),c.name=a,c._parent=this,this[a]=this._regions[a]=c,c},addRegions:function(a){b.each(a,function(a,b){this.addRegion(b,a)},this)},_removeFromParent:function(){e(this._parent,"_removeView",this),this._parent=null},_removeRegion:function(a){this._regions[a.name]&&(delete this[a.name],delete this._regions[a.name])},_jqueryRemove:function(){this.trigger("remove:jquery"),this.remove()},_listenToEvents:function(a,c){a&&b.each(c,function(c,d){b.isFunction(c)||(c=this[c]),this.listenTo(a,d,c)},this)},_ensureRegion:function(a){this.Region=a.Region||this.Region||f.Region},_initializeRegions:function(a){this._regions={};var c=b.result(this,"regions");a.regions&&(c=a.regions),this.addRegions(c)},_viewHelper:function(a){var b=this._regions[a];return b?b.render().el.outerHTML:""}}),f.Region=function(a){this.cid=b.uniqueId("region"),this._ensureView(a||{})},f.Region.extend=d.View.extend,b.extend(f.Region.prototype,d.Events,{View:f.View.extend({tagName:"span",attributes:function(){return{"data-cid":this.cid}}}),_ensureView:function(a){this._view=new this.View,a.view&&(this.view=a.view),this.view instanceof d.View||(this.view=this._view),this._assignParent(this.view)},reset:function(a){this.attach(this._view,a)},render:function(){return this.view.render()},attach:function(a,b){var c=this.view;return this._assignParent(a),this.view.$el.after(a.$el),this.view.$el.detach(),this.view=a,b||c.remove(),a},remove:function(){this._removeViews(),this._removeFromParent()},_removeViews:function(){this.view.remove(),this._view.remove(),e(this._detachedView,"remove")},_removeFromParent:function(){e(this._parent,"_removeRegion",this),this._parent=null},detach:function(){return e(this._detachedView,"remove"),this._detachedView=this.view,this.view!==this._view&&this.reset(!0),this},reattach:function(){if(this._detachedView){var a=this._parent&&this._parent.$el||d.$(document.body),b="[data-cid="+this.view.cid+"]",c=this._detachedView;return a.find(b).replaceWith(c.$el),delete this._detachedView,this.view=c,c}},_removeView:function(a){this.view===a&&this.reset(!0)},_assignParent:function(a){a._parent=this}}),f.ModelView=f.View.extend({modelEvents:{change:"render",destroy:"remove"},serialize:function(){return this.model.attributes}}),f.CollectionView=f.View.extend({constructor:function(a){this._modelViews={},this._ensureModelView(a||{}),f.View.apply(this,arguments),this.listenTo(this,"remove",this._removeModelViews)},collectionEvents:{add:"addOne",remove:"removeOne",reset:"render",sort:"render"},render:function(){this.trigger("render"),this._removeModelViews();var a=this.$el.html(this.template(this._serialize()));return this.$el=c(document.createDocumentFragment()),this.collection.each(this.addOne,this),this.$el=a.append(this.$el),this},addOne:function(a){var b=new this.ModelView({model:a});return this._modelViews[b.cid]=b,b._parent=this,this.trigger("addOne",b),this.$el.append(b.render().$el),b},removeOne:function(a){var c=b.findWhere(this._modelViews,{model:a});return this.trigger("removeOne",c),e(c,"remove"),c},_removeView:function(a){delete this._modelViews[a.cid]},_removeModelViews:function(){b.invoke(this._modelViews,"remove")},_ensureModelView:function(a){this.ModelView=a.ModelView||this.ModelView||f.ModelView}}),f}(this,a,b,c),c.Minionette});