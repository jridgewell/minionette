// Backbone.Minionette
// -------------------
// v0.2.3
//
// Copyright (c)2013 Justin Ridgewell
// Distributed under MIT license
//
// https://github.com/jridgewell/minionette

(function(e,t){"use strict";if("object"==typeof exports){var i=require("underscore"),n=require("jquery"),r=require("backbone");module.exports=t(i,n,r)}else"function"==typeof define&&define.amd&&define(["underscore","jquery","backbone"],t)})(this,function(e,t,i){"use strict";return function(e,t,i,n){var r={};if(n.Minionette=r,i){var o=i.cleanData;i.cleanData=function(e){for(var t,n=0;void 0!==(t=e[n]);n++)try{i(t).triggerHandler("remove")}catch(r){}o(e)}}return r.View=n.View.extend({constructor:function(){n.View.apply(this,arguments),this._subViews={},this._listenToEvents(this.model,this.modelEvents),this._listenToEvents(this.collection,this.collectionEvents)},_parentView:null,template:function(){return""},serializeData:function(){return{}},delegateEvents:function(){n.View.prototype.delegateEvents.apply(this,arguments),t.bindAll(this,"_jqueryRemove"),this.$el.on("remove",this._jqueryRemove)},remove:function(){this.trigger("remove:before"),this._removeSubViews(),n.View.prototype.remove.apply(this,arguments),this.trigger("remove")},render:function(){return this.trigger("render:before"),t.each(this._subViews,function(e){e.$el.detach()}),this.$el.html(this.template(this.serializeData())),this.trigger("render"),this},assign:function(e,i,n){var r;t.isObject(e)?(r=e,n=i):(r={},r[e]=i),r&&t.each(r,function(e,t){this._subViews[e.cid]=e,e._parentView=this,n?this.$(t).replaceWith(e.el):e.setElement(this.$(t)).render()},this)},_removeSubViews:function(){t.invoke(this._subViews,"remove")},_jqueryRemove:function(){this.trigger("remove:jquery"),this.stopListening()},_listenToEvents:function(e,i){if(e){for(var n in i){var r=i[n];t.isFunction(r)||(r=this[r]),r&&this.listenTo(e,n,r)}return this}}}),r.ModelView=r.View.extend({modelEvents:{change:"render",destroy:"remove"},serializeData:function(){return t.clone(this.model.attributes)}}),r.CollectionView=r.View.extend({ModelView:n.View,collectionEvents:{add:"addOne",remove:"removeOne",reset:"render"},render:function(){this.trigger("render:before"),this.$el.html(this.template(this.collection));var e=this._getModelView();return this.collection.each(function(t){this._addModelView(t,e)},this),this.trigger("render"),this},addOne:function(e){this.trigger("addOne:before");var t=this._getModelView();this._addModelView(e,t),this.trigger("addOne")},removeOne:function(e){this.trigger("removeOne:before");var t=this._findSubViewByModel(e);this._removeModelView(t),this.trigger("removeOne")},_addModelView:function(e,t){var i=new t({model:e});this._subViews[i.cid]=i,i._parentView=this,this.$el.append(i.render().el)},_getModelView:function(){var e=this.ModelView;return this.options&&this.options.ModelView&&(e=this.option.ModelView),e},_removeModelView:function(e){e&&(e.remove(),delete this._subViews[e.cid])},_findSubViewByModel:function(e){return t.findWhere(this._subViews,{model:e})}}),r}(this,e,t,i),i.Minionette});